<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>PostgreSQL 初探 - 磊磊落落</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=keywords content="PostgreSQL,初探"><meta name=description content="PostgreSQL初探 (PostgreSQL Getting Started)"><meta name=author content="磊磊落落"><meta name=generator content="Hugo 0.81.0"><link rel=stylesheet href=https://olzhy.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://olzhy.github.io/css/themify-icons.css><link rel=stylesheet href=https://olzhy.github.io/css/larry-custom.css><link rel=stylesheet href=https://olzhy.github.io/scss/style.min.css media=screen><link rel="shortcut icon" href=https://olzhy.github.io/images/favicon.png type=image/x-icon><link rel=icon href=https://olzhy.github.io/images/favicon.png type=image/x-icon><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?526723b767317055572c85bdb445353c",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://olzhy.github.io/>磊磊落落</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://olzhy.github.io/></a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E9%9A%8F%E7%AC%94/>随笔</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%AF%BB%E4%B9%A6/>读书</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%A7%82%E5%BD%B1/>观影</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E7%BB%83%E5%AD%97/>练字</a></li><li class=nav-item><a class=nav-link href=https://olzhy.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/>计算机</a></li></ul><div class=search><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://olzhy.github.io//search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder=键入关键字后回车...></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=section><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h1>PostgreSQL 初探</h1><div class="mb-3 post-meta">2021年05月21日
<a href=/categories/%e8%ae%a1%e7%ae%97%e6%9c%ba>计算机</a></div><div class="content mb-5"><p><a href=/posts/install-postgres-on-centos-from-source.html>上一篇</a>已经安装好了 PostgreSQL 环境，本篇会在其上使用 SQL 做一些简单的操作。</p><h3 id=1-基础-sql-操作>1 基础 SQL 操作</h3><p><strong>a) 建表</strong></p><p>建两张表：一张是天气表（<code>weather</code>），记录各个城市每天的温度与降水量；一张是城市表（<code>cities</code>），记录城市的坐标。PostgreSQL 推荐关键字采用大写格式，字段名及类型采用小写格式。</p><p>如下为建表语句：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> weather (
    city        varchar(<span style=color:#ae81ff>80</span>), <span style=color:#75715e>-- city name (城市名)
</span><span style=color:#75715e></span>    temp_low    int,  <span style=color:#75715e>-- low temperature (最低温度)
</span><span style=color:#75715e></span>    temp_high   int,  <span style=color:#75715e>-- high temperature (最高温度)
</span><span style=color:#75715e></span>    prcp        real, <span style=color:#75715e>-- precipitation (降水量)
</span><span style=color:#75715e></span>    date        date  <span style=color:#75715e>-- date (日期)
</span><span style=color:#75715e></span>);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cities (
    name        varchar(<span style=color:#ae81ff>80</span>), <span style=color:#75715e>-- city name (城市名)
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>location</span>    point <span style=color:#75715e>-- point为PostgreSQL特有类型，该字段表示地理坐标(经度, 纬度)
</span><span style=color:#75715e></span>);
</code></pre></div><p><strong>b) 插值</strong></p><p>采用如下语句分别为<code>weather</code>表及<code>cities</code>表插入数据。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> weather (city, temp_low, temp_high, prcp, date)
    <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;Beijing&#39;</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>25</span>, <span style=color:#e6db74>&#39;2021-05-19&#39;</span>),
           (<span style=color:#e6db74>&#39;Beijing&#39;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;2021-05-20&#39;</span>),
           (<span style=color:#e6db74>&#39;Dalian&#39;</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;2021-05-21&#39;</span>);

<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cities (name, <span style=color:#66d9ef>location</span>)
    <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;Beijing&#39;</span>, <span style=color:#e6db74>&#39;(116.3, 39.9)&#39;</span>),
           (<span style=color:#e6db74>&#39;Shanghai&#39;</span>, <span style=color:#e6db74>&#39;(121.3, 31.1)&#39;</span>);
</code></pre></div><p><strong>c) 简单查询</strong></p><p>在被选列上使用表达式<code>(temp_low + temp_high) / 2</code>，返回城市每天的平均温度。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> city, (temp_low <span style=color:#f92672>+</span> temp_high) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>AS</span> temp_avg, date
<span style=color:#66d9ef>FROM</span> weather;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | temp_avg |    date
---------+----------+------------
 Beijing |       25 | 2021-05-19
 Beijing |       25 | 2021-05-20
 Dalian  |       20 | 2021-05-21
(3 rows)
</code></pre></div><p>使用<code>WHERE</code>条件，筛选城市为 Beijing 且降水量大于 0 的记录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> weather
<span style=color:#66d9ef>WHERE</span> city <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Beijing&#39;</span>
  <span style=color:#66d9ef>AND</span> prcp <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | temp_low | temp_high | prcp |    date
---------+----------+-----------+------+------------
 Beijing |       18 |        32 | 0.25 | 2021-05-19
(1 row)
</code></pre></div><p>在被选列上使用<code>DISTINCT</code>关键字，筛选出去重后的城市名，并使用<code>ORDER BY</code>关键字按城市名字段正序返回结果。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> city
<span style=color:#66d9ef>FROM</span> weather
  <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> city;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city
---------
 Beijing
 Dalian
(2 rows)
</code></pre></div><p><strong>d) 连表查询</strong></p><p>内连接：将<code>weather</code>表及<code>cities</code>表进行内连接（取两表中城市名相同的所有行），返回城市在对应日期的的温度，降水量及地理位置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> w.city, w.temp_low, w.temp_high, w.prcp, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>location</span>, w.date
<span style=color:#66d9ef>FROM</span> weather w, cities <span style=color:#66d9ef>c</span>
<span style=color:#66d9ef>WHERE</span> w.city <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.name;

<span style=color:#75715e>-- 两种写法等价
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> w.city, w.temp_low, w.temp_high, w.prcp, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>location</span>, w.date
<span style=color:#66d9ef>FROM</span> weather w <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> cities <span style=color:#66d9ef>c</span>
  <span style=color:#66d9ef>ON</span> (w.city <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.name);
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | temp_low | temp_high | prcp |   location   |    date
---------+----------+-----------+------+--------------+------------
 Beijing |       18 |        32 | 0.25 | (116.3,39.9) | 2021-05-19
 Beijing |       20 |        30 |    0 | (116.3,39.9) | 2021-05-20
(2 rows)
</code></pre></div><p>左外连接：将<code>weather</code>表及<code>cities</code>表进行左外连接（返回左表所有行，若左表的某行在右表没有匹配行，则补空值），返回城市在对应日期的的温度，降水量及地理位置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> w.city, w.temp_low, w.temp_high, w.prcp, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>location</span>, w.date
<span style=color:#66d9ef>FROM</span> weather w <span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>OUTER</span> <span style=color:#66d9ef>JOIN</span> cities <span style=color:#66d9ef>c</span>
  <span style=color:#66d9ef>ON</span> (w.city <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.name);
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | temp_low | temp_high | prcp |   location   |    date
---------+----------+-----------+------+--------------+------------
 Beijing |       18 |        32 | 0.25 | (116.3,39.9) | 2021-05-19
 Beijing |       20 |        30 |    0 | (116.3,39.9) | 2021-05-20
 Dalian  |       16 |        24 |    0 |              | 2021-05-21
(3 rows)
</code></pre></div><p>右外连接：将<code>weather</code>表及<code>cities</code>表进行右外连接（返回右表所有行，若右表的某行在左表没有匹配行，则补空值），返回城市在对应日期的的温度，降水量及地理位置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>c</span>.name, w.temp_low, w.temp_high, w.prcp, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>location</span>, w.date
<span style=color:#66d9ef>FROM</span> weather w <span style=color:#66d9ef>RIGHT</span> <span style=color:#66d9ef>OUTER</span> <span style=color:#66d9ef>JOIN</span> cities <span style=color:#66d9ef>c</span>
  <span style=color:#66d9ef>ON</span> (w.city <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.name);
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>   name   | temp_low | temp_high | prcp |   location   |    date
----------+----------+-----------+------+--------------+------------
 Beijing  |       20 |        30 |    0 | (116.3,39.9) | 2021-05-20
 Beijing  |       18 |        32 | 0.25 | (116.3,39.9) | 2021-05-19
 Shanghai |          |           |      | (121.3,31.1) |
(3 rows)
</code></pre></div><p>全外连接：将<code>weather</code>表及<code>cities</code>表进行全外连接（返回两表的所有行，当一表的某行在另一表没有匹配行，则补空值），返回城市在对应日期的的温度，降水量及地理位置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> (<span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> w.city <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>THEN</span> w.city <span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>c</span>.name <span style=color:#66d9ef>END</span>), w.temp_low, w.temp_high, w.prcp, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>location</span>, w.date
<span style=color:#66d9ef>FROM</span> weather w <span style=color:#66d9ef>FULL</span> <span style=color:#66d9ef>OUTER</span> <span style=color:#66d9ef>JOIN</span> cities <span style=color:#66d9ef>c</span>
  <span style=color:#66d9ef>ON</span> (w.city <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.name);
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>   name   | temp_low | temp_high | prcp |   location   |    date
----------+----------+-----------+------+--------------+------------
 Beijing  |       18 |        32 | 0.25 | (116.3,39.9) | 2021-05-19
 Beijing  |       20 |        30 |    0 | (116.3,39.9) | 2021-05-20
 Dalian   |       16 |        24 |    0 |              | 2021-05-21
 Shanghai |          |           |      | (121.3,31.1) |
(4 rows)
</code></pre></div><p>自连接：<code>weather</code>表与自己连接，找出同一城市，某一天的最低温度比另一天低的记录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> w1.city, w1.temp_low, w1.date, w2.temp_low, w2.date
<span style=color:#66d9ef>FROM</span> weather w1, weather w2
<span style=color:#66d9ef>WHERE</span> w1.city <span style=color:#f92672>=</span> w2.city
  <span style=color:#66d9ef>AND</span> w1.temp_low <span style=color:#f92672>&lt;</span> w2.temp_low;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | temp_low |    date    | temp_low |    date
---------+----------+------------+----------+------------
 Beijing |       18 | 2021-05-19 |       20 | 2021-05-20
(1 row)
</code></pre></div><p><strong>e) 聚集函数使用</strong></p><p>聚集函数针对多行输入计算一个结果。</p><p>下面，找出<code>weather</code>表中的历史最低温度。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>min</span>(temp_low) <span style=color:#66d9ef>FROM</span> weather;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text> min
-----
  16
(1 row)
</code></pre></div><p>找出拥有这个历史最低温度的是哪个城市哪一天的记录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 使用子查询
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> city, temp_low, date
<span style=color:#66d9ef>FROM</span> weather
<span style=color:#66d9ef>WHERE</span> temp_low <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>min</span>(temp_low) <span style=color:#66d9ef>FROM</span> weather);

<span style=color:#75715e>-- 错误写法 聚集函数不允许在WHERE条件中使用
</span><span style=color:#75715e>-- SELECT city FROM weather WHERE temp_low = min(temp_low);
</span></code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city  | temp_low |    date
--------+----------+------------
 Dalian |       16 | 2021-05-21
(1 row)
</code></pre></div><p>聚集函数结合<code>GROUP BY</code>找出每个城市的历史最低温度。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> city, <span style=color:#66d9ef>min</span>(temp_low)
<span style=color:#66d9ef>FROM</span> weather
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> city;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | min
---------+-----
 Dalian  |  16
 Beijing |  18
(2 rows)
</code></pre></div><p>进一步找出每个城市历史最低温度低于 17 的记录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> city, <span style=color:#66d9ef>min</span>(temp_low)
<span style=color:#66d9ef>FROM</span> weather
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> city
  <span style=color:#66d9ef>HAVING</span> <span style=color:#66d9ef>min</span>(temp_low) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>17</span>;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city  | min
--------+-----
 Dalian |  16
(1 row)
</code></pre></div><p>从如上示例也看到了<code>WHERE</code>与<code>HAVING</code>使用场景的不同：<code>WHERE</code>用于分组和聚集函数使用前的输入行筛选；而<code>HAVING</code>用于分组和聚集函数使用后的分组行筛选。且<code>WHERE</code>语句中不可以使用聚集函数，而<code>HAVING</code>语句中一般总使用聚集函数（<code>HAVING</code>语句中不使用聚集函数的条件，不如直接将其移到<code>WHERE</code>语句中）。</p><p>如，接着上面，筛选首字母为<code>D</code>的城市，并返回这些城市历史最低温度低于 17 的记录。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> city, <span style=color:#66d9ef>min</span>(temp_low)
<span style=color:#66d9ef>FROM</span> weather
<span style=color:#66d9ef>WHERE</span> city <span style=color:#66d9ef>like</span> <span style=color:#e6db74>&#39;D%&#39;</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> city
  <span style=color:#66d9ef>HAVING</span> <span style=color:#66d9ef>min</span>(temp_low) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>17</span>;

<span style=color:#75715e>-- 不要用这种写法
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> city, <span style=color:#66d9ef>min</span>(temp_low)
<span style=color:#66d9ef>FROM</span> weather
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> city
  <span style=color:#66d9ef>HAVING</span> <span style=color:#66d9ef>min</span>(temp_low) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>17</span> <span style=color:#66d9ef>AND</span> city <span style=color:#66d9ef>like</span> <span style=color:#e6db74>&#39;D%&#39;</span>;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city  | min
--------+-----
 Dalian |  16
(1 row)
</code></pre></div><p><strong>f) 更新及删除</strong></p><p>假定<code>2021-05-20</code>及之后的数据录入时温度均比实际值低了 1 度，可以使用如下<code>UPDATE</code>语句进行校正。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>UPDATE</span> weather
  <span style=color:#66d9ef>SET</span> temp_low <span style=color:#f92672>=</span> temp_low <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, temp_high <span style=color:#f92672>=</span> temp_high <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>WHERE</span> date <span style=color:#f92672>&gt;=</span> <span style=color:#e6db74>&#39;2021-05-20&#39;</span>;
</code></pre></div><p>重新查询数据。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> weather;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city   | temp_low | temp_high | prcp |    date
---------+----------+-----------+------+------------
 Beijing |       18 |        32 | 0.25 | 2021-05-19
 Beijing |       21 |        31 |    0 | 2021-05-20
 Dalian  |       17 |        25 |    0 | 2021-05-21
(3 rows)
</code></pre></div><p>若不再需要城市名为<code>Beijing</code>的数据，可以使用<code>DELETE</code>语句进行删除。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> weather <span style=color:#66d9ef>WHERE</span> city <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Beijing&#39;</span>;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> weather;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  city  | temp_low | temp_high | prcp |    date
--------+----------+-----------+------+------------
 Dalian |       17 |        25 |    0 | 2021-05-21
(1 row)
</code></pre></div><p>若整个表的数据都不需要了，确认无误后，可以进行删除。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> weather;
</code></pre></div><h3 id=2-高级特性>2 高级特性</h3><p><strong>a) 视图</strong></p><p>针对上面的场景，若天气与城市坐标总是一起展示，则可以为其创建视图，其使用跟普通的表一样。视图有许多好处，如隐藏表的细节，可以随着应用演进而不必更改接口定义。当然还可以在视图上创建视图。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>VIEW</span> myview <span style=color:#66d9ef>AS</span>
    <span style=color:#66d9ef>SELECT</span> w.city, w.temp_low, w.temp_high, w.prcp, <span style=color:#66d9ef>c</span>.<span style=color:#66d9ef>location</span>, w.date
    <span style=color:#66d9ef>FROM</span> weather w, cities <span style=color:#66d9ef>c</span>
    <span style=color:#66d9ef>WHERE</span> w.city <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.name;

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> myview;
</code></pre></div><p><strong>b) 外健</strong></p><p>针对上述天气表<code>weather</code>与城市表<code>cities</code>，若我们要确保没有人可以在<code>weather</code>表插入<code>cities</code>表中不存在的城市的天气记录。这种约束即是保障数据的参照完整性，可以使用外健来实现。</p><p>新的表定义如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cities (
    name varchar(<span style=color:#ae81ff>80</span>) <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
    <span style=color:#66d9ef>location</span> point
);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> weather (
    city varchar(<span style=color:#ae81ff>80</span>) <span style=color:#66d9ef>references</span> cities(name),
    temp_low int,
    temp_high int,
    prcp real,
    date date
);
</code></pre></div><p>现在尝试对<code>weather</code>表插入一个新的城市的天气记录，会报错。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> weather <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;Tianjin&#39;</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;2021-05-22&#39;</span>);
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ERROR:  insert or update on table &#34;weather&#34; violates foreign key constraint &#34;weather_city_fkey&#34;
DETAIL:  Key (city)=(Tianjin) is not present in table &#34;cities&#34;.
</code></pre></div><p>在<code>cities</code>表补全该城市后，即可对<code>weather</code>进行插入。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> cities <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;Tianjin&#39;</span>, <span style=color:#e6db74>&#39;(117.2, 39.1)&#39;</span>);
<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> weather <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;Tianjin&#39;</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;2021-05-22&#39;</span>);
</code></pre></div><p>同理，<code>cities</code>表被参照，所以涉及被参考字段数据的更新及删除等都会受影响。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> cities <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Tianjin&#39;</span>;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ERROR:  update or delete on table &#34;cities&#34; violates foreign key constraint &#34;weather_city_fkey&#34; on table &#34;weather&#34;
DETAIL:  Key (name)=(Tianjin) is still referenced from table &#34;weather&#34;.
</code></pre></div><p><strong>c) 事务</strong></p><p>事务将多步操作看作一个单元，这些操作要么都做，要么都不做。</p><p>现有两张表，<code>accounts</code>与<code>branches</code>，分别用于记录客户余额与分行总余额。现在 Alice 想给 Bob 转 100.00 块钱。可以将 SQL 语句用<code>BEGIN</code>及<code>COMMIT</code>包起来作为一个事务块。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>BEGIN</span>;
<span style=color:#75715e>-- Alice的账户余额减去100.00
</span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>-</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Alice&#39;</span>;
<span style=color:#75715e>-- Alice所在分行总余额减去100.00
</span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> branches <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>-</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> branch_name <span style=color:#66d9ef>FROM</span> accounts <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Alice&#39;</span>);
<span style=color:#75715e>-- Bob的账户余额加上100.00
</span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Bob&#39;</span>;
<span style=color:#75715e>-- Bob所在分行总余额加上100.00
</span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> branches <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> branch_name <span style=color:#66d9ef>FROM</span> accounts <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Bob&#39;</span>);
<span style=color:#66d9ef>COMMIT</span>;
</code></pre></div><p>此外，在事务中还可以使用<code>SAVEPOINT</code>来细粒度控制执行语句。</p><p>假定从 Alice 的账号给 Bob 的账号打 100.00 块钱，后来才发现收款人应是 Wally。使用<code>SAVEPOINT</code>的语句如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>BEGIN</span>;
<span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>-</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Alice&#39;</span>;
SAVEPOINT my_savepoint;
<span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Bob&#39;</span>;
<span style=color:#75715e>-- oops ... forget that and use Wally&#39;s account
</span><span style=color:#75715e></span><span style=color:#66d9ef>ROLLBACK</span> <span style=color:#66d9ef>TO</span> my_savepoint;
<span style=color:#66d9ef>UPDATE</span> accounts <span style=color:#66d9ef>SET</span> balance <span style=color:#f92672>=</span> balance <span style=color:#f92672>+</span> <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>
    <span style=color:#66d9ef>WHERE</span> name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Wally&#39;</span>;
<span style=color:#66d9ef>COMMIT</span>;
</code></pre></div><p><strong>d) 窗口函数</strong></p><p>窗口函数针对与当前行有某种关联的一组行进行计算。然而，窗口函数不会像非窗口聚集函数那样将一组行分组为一个单个的输出行，其会保留独立的输出行。</p><p>窗口函数使用<code>OVER</code>子句来确定如何对行进行分区，以供窗口函数处理。<code>OVER</code>子句中的<code>PARTITION BY</code>用于将行分区。对于每一行，窗口函数会对与其落入同一分区的行进行计算。</p><p>还可以使用<code>OVER</code>中的<code>ORDER BY</code>来控制窗口函数处理行的顺序。若省略<code>PARTITION BY</code>，表示所有行均落入一个分区。若省略<code>ORDER BY</code>，表示默认窗口包含分区中的所有行；若指定<code>ORDER BY</code>，窗口会包含从分区开始到当前行，以及根据<code>ORDER BY</code>子句与当前行相等的行。</p><p>下面演示如何使用窗口函数。</p><p>创建雇员薪资表<code>empsalary</code>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> empsalary (
    depname varchar,  <span style=color:#75715e>-- 部门名称
</span><span style=color:#75715e></span>    empno bigint,     <span style=color:#75715e>-- 雇员编号
</span><span style=color:#75715e></span>    salary int,       <span style=color:#75715e>-- 薪资
</span><span style=color:#75715e></span>    enroll_date date  <span style=color:#75715e>-- 入职日期
</span><span style=color:#75715e></span>);
</code></pre></div><p>插入数据：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> empsalary (depname, empno, salary, enroll_date)
    <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;develop&#39;</span>,<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>5200</span>, <span style=color:#e6db74>&#39;2021/08/01&#39;</span>),
           (<span style=color:#e6db74>&#39;sales&#39;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5000</span>, <span style=color:#e6db74>&#39;2021/10/01&#39;</span>),
           (<span style=color:#e6db74>&#39;personnel&#39;</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>3500</span>, <span style=color:#e6db74>&#39;2021/12/10&#39;</span>),
           (<span style=color:#e6db74>&#39;sales&#39;</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4800</span>, <span style=color:#e6db74>&#39;2021/08/08&#39;</span>),
           (<span style=color:#e6db74>&#39;sales&#39;</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>5500</span>, <span style=color:#e6db74>&#39;2021/01/02&#39;</span>),
           (<span style=color:#e6db74>&#39;personnel&#39;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3900</span>, <span style=color:#e6db74>&#39;2021/12/23&#39;</span>),
           (<span style=color:#e6db74>&#39;develop&#39;</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>4200</span>, <span style=color:#e6db74>&#39;2021/01/01&#39;</span>),
           (<span style=color:#e6db74>&#39;develop&#39;</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>4500</span>, <span style=color:#e6db74>&#39;2021/01/01&#39;</span>),
           (<span style=color:#e6db74>&#39;sales&#39;</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4800</span>, <span style=color:#e6db74>&#39;2021/08/01&#39;</span>),
           (<span style=color:#e6db74>&#39;develop&#39;</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>6000</span>, <span style=color:#e6db74>&#39;2021/10/01&#39;</span>),
           (<span style=color:#e6db74>&#39;develop&#39;</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>5200</span>, <span style=color:#e6db74>&#39;2021/08/15&#39;</span>);
</code></pre></div><p>使用如下 SQL 列出每个雇员的信息及部门平均薪资。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>, <span style=color:#66d9ef>avg</span>(salary) OVER (PARTITION <span style=color:#66d9ef>BY</span> depname) <span style=color:#66d9ef>FROM</span> empsalary;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  depname  | empno | salary | enroll_date |          avg
-----------+-------+--------+-------------+-----------------------
 develop   |    10 |   5200 | 2007-08-01  | 5020.0000000000000000
 develop   |     7 |   4200 | 2008-01-01  | 5020.0000000000000000
 develop   |     9 |   4500 | 2008-01-01  | 5020.0000000000000000
 develop   |     8 |   6000 | 2006-10-01  | 5020.0000000000000000
 develop   |    11 |   5200 | 2007-08-15  | 5020.0000000000000000
 personnel |     2 |   3900 | 2006-12-23  | 3700.0000000000000000
 personnel |     5 |   3500 | 2007-12-10  | 3700.0000000000000000
 sales     |     3 |   4800 | 2007-08-01  | 5025.0000000000000000
 sales     |     1 |   5000 | 2006-10-01  | 5025.0000000000000000
 sales     |     4 |   4800 | 2007-08-08  | 5025.0000000000000000
 sales     |     6 |   5500 | 2007-01-02  | 5025.0000000000000000
(11 rows)
</code></pre></div><p>使用如下 SQL 列出每个雇员的信息及部门内薪资排名。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
    <span style=color:#f92672>*</span>,
    rank() OVER (PARTITION <span style=color:#66d9ef>BY</span> depname <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> salary <span style=color:#66d9ef>DESC</span>)
<span style=color:#66d9ef>FROM</span>
    empsalary;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  depname  | empno | salary | enroll_date | rank
-----------+-------+--------+-------------+------
 develop   |     8 |   6000 | 2006-10-01  |    1
 develop   |    10 |   5200 | 2007-08-01  |    2
 develop   |    11 |   5200 | 2007-08-15  |    2
 develop   |     9 |   4500 | 2008-01-01  |    4
 develop   |     7 |   4200 | 2008-01-01  |    5
 personnel |     2 |   3900 | 2006-12-23  |    1
 personnel |     5 |   3500 | 2007-12-10  |    2
 sales     |     6 |   5500 | 2007-01-02  |    1
 sales     |     1 |   5000 | 2006-10-01  |    2
 sales     |     3 |   4800 | 2007-08-01  |    3
 sales     |     4 |   4800 | 2007-08-08  |    3
(11 rows)
</code></pre></div><p>使用如下 SQL 列出所有部门的雇员信息及全员薪资总和。（未使用<code>PARTITION BY</code>，表示全表为一个分区）</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
    <span style=color:#f92672>*</span>,
    <span style=color:#66d9ef>sum</span>(salary) OVER ()
<span style=color:#66d9ef>FROM</span>
    empsalary;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  depname  | empno | salary | enroll_date |  sum
-----------+-------+--------+-------------+-------
 develop   |    10 |   5200 | 2007-08-01  | 52600
 sales     |     1 |   5000 | 2006-10-01  | 52600
 personnel |     5 |   3500 | 2007-12-10  | 52600
 sales     |     4 |   4800 | 2007-08-08  | 52600
 sales     |     6 |   5500 | 2007-01-02  | 52600
 personnel |     2 |   3900 | 2006-12-23  | 52600
 develop   |     7 |   4200 | 2008-01-01  | 52600
 develop   |     9 |   4500 | 2008-01-01  | 52600
 sales     |     3 |   4800 | 2007-08-01  | 52600
 develop   |     8 |   6000 | 2006-10-01  | 52600
 develop   |    11 |   5200 | 2007-08-15  | 52600
(11 rows)
</code></pre></div><p>注意，若对如上 SQL 指定了<code>ORDER BY</code>，结果大不同。这是因为指定<code>ORDER BY</code>后，<code>sum</code>针对的是最低薪资到当前行及与当前薪资相等的行的计算。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
    <span style=color:#f92672>*</span>,
    <span style=color:#66d9ef>sum</span>(salary) OVER (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> salary)
<span style=color:#66d9ef>FROM</span>
    empsalary;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  depname  | empno | salary | enroll_date |  sum
-----------+-------+--------+-------------+-------
 personnel |     5 |   3500 | 2007-12-10  |  3500
 personnel |     2 |   3900 | 2006-12-23  |  7400
 develop   |     7 |   4200 | 2008-01-01  | 11600
 develop   |     9 |   4500 | 2008-01-01  | 16100
 sales     |     4 |   4800 | 2007-08-08  | 25700
 sales     |     3 |   4800 | 2007-08-01  | 25700
 sales     |     1 |   5000 | 2006-10-01  | 30700
 develop   |    11 |   5200 | 2007-08-15  | 41100
 develop   |    10 |   5200 | 2007-08-01  | 41100
 sales     |     6 |   5500 | 2007-01-02  | 46600
 develop   |     8 |   6000 | 2006-10-01  | 52600
(11 rows)
</code></pre></div><p>若查询涉及多个窗口函数，建议将<code>WINDOW</code>子句抽出来，以便在<code>OVER</code>中引用。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
    <span style=color:#f92672>*</span>,
    <span style=color:#66d9ef>avg</span>(salary) OVER w,
    <span style=color:#66d9ef>sum</span>(salary) OVER w
<span style=color:#66d9ef>FROM</span>
    empsalary WINDOW w <span style=color:#66d9ef>AS</span> (PARTITION <span style=color:#66d9ef>BY</span> depname);
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>  depname  | empno | salary | enroll_date |          avg          |  sum
-----------+-------+--------+-------------+-----------------------+-------
 develop   |    10 |   5200 | 2007-08-01  | 5020.0000000000000000 | 25100
 develop   |     7 |   4200 | 2008-01-01  | 5020.0000000000000000 | 25100
 develop   |     9 |   4500 | 2008-01-01  | 5020.0000000000000000 | 25100
 develop   |     8 |   6000 | 2006-10-01  | 5020.0000000000000000 | 25100
 develop   |    11 |   5200 | 2007-08-15  | 5020.0000000000000000 | 25100
 personnel |     2 |   3900 | 2006-12-23  | 3700.0000000000000000 |  7400
 personnel |     5 |   3500 | 2007-12-10  | 3700.0000000000000000 |  7400
 sales     |     3 |   4800 | 2007-08-01  | 5025.0000000000000000 | 20100
 sales     |     1 |   5000 | 2006-10-01  | 5025.0000000000000000 | 20100
 sales     |     4 |   4800 | 2007-08-08  | 5025.0000000000000000 | 20100
 sales     |     6 |   5500 | 2007-01-02  | 5025.0000000000000000 | 20100
(11 rows)
</code></pre></div><p><strong>e) 表继承</strong></p><p>PostgreSQL 支持表继承，下面创建城市表<code>cities</code>，及首都表<code>capitals</code>，首都表继承城市表。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cities (
  name       text,  <span style=color:#75715e>-- 城市名
</span><span style=color:#75715e></span>  population real,  <span style=color:#75715e>-- 人口数
</span><span style=color:#75715e></span>  elevation  int    <span style=color:#75715e>-- 海拔高度
</span><span style=color:#75715e></span>);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> capitals (
  <span style=color:#66d9ef>state</span>      char(<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#75715e>-- 州
</span><span style=color:#75715e></span>) <span style=color:#66d9ef>INHERITS</span> (cities);
</code></pre></div><p>使用如下 SQL 查询包含首都的所有城市：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> cities;
</code></pre></div><p>使用如下 SQL 查询不包含首都的所有城市：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>ONLY</span> cities;
</code></pre></div><p>综上，本文对 PostgreSQL 的基础功能及高级功能进行了初探。</p><blockquote><p>参考资料</p><p>[1]<a href=https://www.postgresql.org/docs/13/tutorial.html>postgresql tutorial</a></p></blockquote></div><div class=content-footer><div class=post-tags><a href=/tags/postgresql/>#PostgreSQL</a></div></div></div><div class="col-lg-8 mx-auto block shadow"><h3>相关文章</h3><ul><li><a href=/posts/postgres-exercises.html>PostgreSQL 基础知识在线练习</a></li><li><a href=/posts/install-postgres-on-centos-from-source.html>在 CentOS 上以源码安装 PostgreSQL</a></li><li><a href=/posts/postgres-ddl.html>PostgreSQL 数据定义相关知识总结</a></li><li><a href=/posts/postgres-table-partitioning.html>PostgreSQL 表分区使用详解</a></li><li><a href=/posts/postgres-table-inheritance.html>PostgreSQL 表继承使用详解</a></li></ul></div><div class="col-lg-8 mx-auto block shadow"><div align=center><table><tr><b style=color:#e8505b>创作不易，如果我的文章确实帮助到了您，请我喝一杯饮料就是一种莫大的支持！<a href=/thanks>Thanks!</a></b></tr><tr><td align=center><b>微信</b></td><td></td><td></td><td></td><td></td><td align=center><b>支付宝</b></td></tr><tr><td><img src=/static/images/self/wechat.png style=width:120px;height:120px></td><td></td><td></td><td></td><td></td><td><img src=/static/images/self/alipay.png style=width:120px;height:120px></td></tr></table></div></div><script src=https://utteranc.es/client.js repo=olzhy/olzhy.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></section><footer class="py-4 bg-lights border-top"><div class=container><div class="row justify-content-between text-center align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/leetcode-golang-implementations>LeetCode</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/about>关于本站</a></li><li class=list-inline-item><a class="text-dark d-block p-2" href=https://olzhy.github.io/links>友情链接</a></li></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a title=文章归档 href=/archives/><i class=ti-archive></i></a></li><li class=list-inline-item><a title=文章标签 href=/tags/><i class=ti-tag></i></a></li><li class=list-inline-item><a title="我的 GitHub" href=https://github.com/olzhy><i class=ti-github></i></a></li><li class=list-inline-item><a title="网站 RSS" href=/index.xml><i class=ti-rss></i></a></li></ul></div></div><div class="text-center mt-4"><span>Made with <a href=https://gohugo.io/>Hugo</a> | Theme <a href=https://github.com/themefisher/northendlab-hugo>NorthendLab</a> | <a href=https://beian.miit.gov.cn>辽ICP备2022012085号-1</a> | Copyright © 2017-2023</span></div></div></footer><script>var indexURL="https://olzhy.github.io/index.json"</script><script src=https://olzhy.github.io/js/jquery.min.js></script><script src=https://olzhy.github.io/js/bootstrap.min.js></script><script src=https://olzhy.github.io/js/fuse.min.js></script><script src=https://olzhy.github.io/js/mark.js></script><script src=https://olzhy.github.io/js/search.js></script><script src=https://olzhy.github.io/js/script.min.js></script></body></html>